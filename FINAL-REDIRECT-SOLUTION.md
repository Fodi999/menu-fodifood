# ‚úÖ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –†–ï–î–ò–†–ï–ö–¢–û–ú

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ NextAuth –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ `/auth/signin` –≤–º–µ—Å—Ç–æ `/profile` –∏–ª–∏ `/admin`.

## üîß –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω `redirect` callback –≤ NextAuth (`src/auth.ts`)

```typescript
callbacks: {
  async redirect({ url, baseUrl }) {
    // –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    console.log(`üîÄ Redirect callback: url=${url}, baseUrl=${baseUrl}`);
    
    // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –∏ NextAuth —Ö–æ—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ /auth/signin - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    if (url === `${baseUrl}/auth/signin` || url === '/auth/signin') {
      console.log(`‚ö†Ô∏è Prevented redirect to signin, using /profile instead`);
      return `${baseUrl}/profile`;
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π URL, –¥–µ–ª–∞–µ–º –µ–≥–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–º
    if (url.startsWith('/')) {
      return `${baseUrl}${url}`;
    }
    
    // –ï—Å–ª–∏ URL –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω–∞—à–µ–º—É –¥–æ–º–µ–Ω—É, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
    if (url.startsWith(baseUrl)) {
      return url;
    }
    
    // –í–Ω–µ—à–Ω–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π URL
    console.log(`‚ö†Ô∏è External redirect blocked: ${url}`);
    return baseUrl;
  },
  // ...–æ—Å—Ç–∞–ª—å–Ω—ã–µ callbacks
}
```

### 2. –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞ (`src/app/auth/signin/page.tsx`)

**–ë—ã–ª–æ:**
- `redirect: false`
- –†—É—á–Ω–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ `router.push()`
- –ó–∞–¥–µ—Ä–∂–∫–∏ –∏ `window.location.href`
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–µ—Å—Å–∏–∏

**–°—Ç–∞–ª–æ:**
```typescript
await signIn("credentials", {
  email,
  password,
  callbackUrl: '/profile', // –∏–ª–∏ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  redirect: true, // NextAuth —Å–∞–º –¥–µ–ª–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ redirect callback
});
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```typescript
const searchParams = useSearchParams();

useEffect(() => {
  const urlError = searchParams.get('error');
  if (urlError) {
    console.error("‚ùå Auth error from URL:", urlError);
    setError("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
  }
}, [searchParams]);
```

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞**
   - `signIn()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å `redirect: true` –∏ `callbackUrl: '/profile'`

2. **NextAuth –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç credentials**
   - –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è JWT —Ç–æ–∫–µ–Ω
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ `/auth/signin?error=...`

3. **NextAuth –≤—ã–∑—ã–≤–∞–µ—Ç redirect callback**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫—É–¥–∞ NextAuth —Ö–æ—á–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å
   - –ï—Å–ª–∏ —ç—Ç–æ `/auth/signin` ‚Üí –ø–æ–¥–º–µ–Ω—è–µ—Ç –Ω–∞ `/profile`
   - –ï—Å–ª–∏ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π URL –Ω–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞ ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ—Ç
   - –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —Ü–µ–ª–µ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É**
   - `/profile` –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - `/admin` –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π callbackUrl)

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç —Ä—É—á–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ –∏ –∑–∞–¥–µ—Ä–∂–µ–∫  
‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - NextAuth —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º  
‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - –≤—Å–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤  
‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ª–æ–∫–∞–ª—å–Ω–æ, –∏ –Ω–∞ Vercel  

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
npm run dev
# –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000/auth/signin
# –í–æ–π—Ç–∏ –∫–∞–∫ admin@example.com / admin123
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /profile
```

### –ù–∞ Vercel:
```bash
./scripts/test-vercel-login.sh
```

## üìù –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

1. **`trustHost: true`** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Vercel!
2. **`strategy: "jwt"`** - –∏—Å–ø–æ–ª—å–∑—É–µ–º JWT –≤–º–µ—Å—Ç–æ database sessions
3. **–£–¥–∞–ª—ë–Ω –±–ª–æ–∫ `cookies`** - NextAuth —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç cookies –ø—Ä–∏ JWT
4. **`redirect` callback** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤

## üîç –û—Ç–ª–∞–¥–∫–∞

–í—Å–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
```
üîÄ Redirect callback: url=http://localhost:3000/auth/signin, baseUrl=http://localhost:3000
‚ö†Ô∏è Prevented redirect to signin, using /profile instead
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞:
```bash
curl https://menu-fodifood.vercel.app/api/auth/session \
  -H "Cookie: next-auth.session-token=..."
```

## ‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚úÖ –í—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/profile` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
- ‚úÖ –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—Ö–æ–¥
- ‚úÖ –°–µ—Å—Å–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ Header –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

---

**–î–∞—Ç–∞:** 2024-01-XX  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Vercel
